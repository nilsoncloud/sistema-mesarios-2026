<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Eleitoral 2026 - Relatórios com Gráficos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { transition: all 0.3s; font-family: system-ui, sans-serif; }
    .sidebar {
      position: fixed; top: 0; left: 0; height: 100vh; width: 280px; background: #1e293b; color: #e2e8f0;
      padding-top: 70px; z-index: 1000; overflow-y: auto; box-shadow: 3px 0 15px rgba(0,0,0,0.3);
    }
    .sidebar .nav-link {
      color: #cbd5e1; padding: 14px 20px; border-radius: 10px; margin: 6px 15px; transition: all 0.2s;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { background: #334155; color: white; }
    .main-content { margin-left: 280px; padding: 25px; min-height: 100vh; }
    @media (max-width: 992px) {
      .sidebar { width: 80px; }
      .sidebar .nav-text { display: none; }
      .sidebar .nav-link { text-align: center; padding: 18px 0; font-size: 1.5rem; }
      .main-content { margin-left: 80px; }
    }
    .dark-mode { background: #0f172a !important; color: #e2e8f0 !important; }
    .dark-mode .card, .dark-mode .table { background: #1e293b !important; color: #e2e8f0 !important; border-color: #334155 !important; }
    .dark-mode .form-control, .dark-mode .form-select { background: #334155; color: #e2e8f0; border-color: #475569; }
    .section { display: none; }
    .section.active { display: block; }
    @media print {
      .sidebar { display: none !important; }
      .main-content { margin-left: 0 !important; padding: 0 !important; }
      .no-print { display: none !important; }
      .card { box-shadow: none !important; border: none !important; }
      table { font-size: 12px; }
    }
    #grafico-relatorio { max-height: 400px; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="p-3 text-center d-none d-lg-block">
      <h4 class="text-white fw-bold">Controle 2026</h4>
    </div>
    <nav class="nav flex-column">
      <a class="nav-link active" data-section="dashboard"><i class="bi bi-house"></i> <span class="nav-text">Dashboard</span></a>
      <hr class="text-secondary d-none d-lg-block">
      <h6 class="text-muted px-3 mt-3 d-none d-lg-block text-uppercase small">Lotes RAES</h6>
      <a class="nav-link" data-section="lotes-mov"><i class="bi bi-box-seam"></i> <span class="nav-text">Movimentação de Lotes</span></a>
      <a class="nav-link" data-section="lotes-arq"><i class="bi bi-archive"></i> <span class="nav-text">Arquivamento</span></a>
      <a class="nav-link" data-section="rel-lotes"><i class="bi bi-graph-up"></i> <span class="nav-text">Relatórios de Lotes</span></a>
      <hr class="text-secondary d-none d-lg-block">
      <h6 class="text-muted px-3 mt-3 d-none d-lg-block text-uppercase small">Mesários</h6>
      <a class="nav-link" data-section="import-mesarios"><i class="bi bi-file-earmark-spreadsheet"></i> <span class="nav-text">Importar Mesários</span></a>
      <a class="nav-link" data-section="lista-mesarios"><i class="bi bi-people"></i> <span class="nav-text">Lista de Mesários</span></a>
      <a class="nav-link" data-section="mov-faltosos"><i class="bi bi-person-x"></i> <span class="nav-text">Marcar Faltosos</span></a>
      <a class="nav-link" data-section="pedidos-folga"><i class="bi bi-calendar-x"></i> <span class="nav-text">Pedidos de Folga</span></a>
      <a class="nav-link" data-section="rel-mesarios"><i class="bi bi-file-earmark-bar-graph"></i> <span class="nav-text">Relatórios de Mesários</span></a>
      <hr class="text-secondary d-none d-lg-block">
      <a class="nav-link" data-section="config"><i class="bi bi-gear"></i> <span class="nav-text">Configurações</span></a>
    </nav>
  </div>

  <!-- Conteúdo Principal -->
  <div class="main-content">
    <div class="container-fluid">

      <!-- Dashboard -->
      <div id="dashboard" class="section active">
        <h2 class="mb-4">Dashboard - Eleições 2026</h2>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card shadow-sm h-100">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-primary">Lotes e Solicitações Web</h5>
                <p class="card-text flex-grow-1">Controle completo de lotes RAES.</p>
                <button class="btn btn-primary mt-auto no-print" onclick="abrirSecao('lotes-mov')">Acessar</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm h-100">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-success">Atividades Cartorárias</h5>
                <p class="card-text flex-grow-1">Gestão interna do cartório.</p>
                <button class="btn btn-success mt-auto disabled">Em desenvolvimento</button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm h-100">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-info">Relatórios Completos</h5>
                <p class="card-text flex-grow-1">Com gráficos e impressão otimizada.</p>
                <button class="btn btn-info mt-auto no-print" onclick="abrirSecao('rel-mesarios')">Abrir Relatórios</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RELATÓRIOS DE MESÁRIOS COM GRÁFICOS -->
      <div id="rel-mesarios" class="section">
        <h2>Relatórios de Mesários</h2>
        <div class="card mb-4">
          <div class="card-body">
            <div class="btn-group w-100" role="group">
              <button class="btn btn-danger" onclick="gerarRelatorio('faltosos')">Faltosos</button>
              <button class="btn btn-warning" onclick="gerarRelatorio('folga')">Com Folga</button>
              <button class="btn btn-info" onclick="gerarRelatorio('todos')">Todos os Mesários</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 id="titulo-relatorio">Selecione um relatório acima</h5>
            <div class="no-print">
              <button class="btn btn-success btn-sm me-2" onclick="exportarCSVRelatorio()">Exportar CSV</button>
              <button class="btn btn-secondary btn-sm" onclick="imprimirRelatorio()">Imprimir Relatório</button>
            </div>
          </div>
          <div class="card-body">
            <!-- Gráfico -->
            <div class="row mb-4">
              <div class="col-md-6">
                <canvas id="grafico-relatorio"></canvas>
              </div>
              <div class="col-md-6">
                <div id="total-relatorio" class="alert alert-info">Total: 0 mesário(s)</div>
              </div>
            </div>
            <!-- Filtros -->
            <div class="row mb-3 no-print">
              <div class="col-md-4">
                <input type="text" id="filtro-nome-rel" class="form-control" placeholder="Filtrar por nome..." onkeyup="aplicarFiltroRelatorio()">
              </div>
              <div class="col-md-4">
                <select id="filtro-municipio-rel" class="form-select" onchange="aplicarFiltroRelatorio()">
                  <option value="">Todos os municípios</option>
                  <option>Concórdia</option>
                  <option>Bujaru</option>
                </select>
              </div>
            </div>
            <!-- Tabela -->
            <div class="table-responsive">
              <table class="table table-striped" id="tabela-relatorio">
                <thead class="table-dark"><tr><th>Nome</th><th>Inscrição</th><th>Função</th><th>Local Trabalho</th><th>Município</th><th>Status</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Lotes (exemplo) -->
      <div id="lotes-mov" class="section">
        <h2>Movimentação de Lotes RAES</h2>
        <div class="card">
          <div class="card-body">
            <div class="row g-3 mb-3">
              <div class="col-md-5"><input type="text" id="lote-num" class="form-control" placeholder="Nº do Lote" maxlength="200"></div>
              <div class="col-md-4"><input type="date" id="lote-data" class="form-control"></div>
              <div class="col-md-3"><button class="btn btn-success w-100 no-print" onclick="addLote()">Adicionar</button></div>
            </div>
            <table class="table" id="tabela-lotes"><thead class="table-dark"><tr><th>Lote</th><th>Data</th><th>Dias</th><th>Status</th><th>Ação</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

      <!-- Configurações -->
      <div id="config" class="section">
        <h2>Configurações</h2>
        <div class="card">
          <div class="card-body">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
              <label class="form-check-label" for="darkModeToggle">Modo Escuro</label>
            </div>
            <button class="btn btn-danger no-print" onclick="if(confirm('Resetar todos os dados?')) {localStorage.clear(); location.reload();}">Resetar Sistema</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Dados de exemplo (adicione mais via importação)
    let lotes = JSON.parse(localStorage.getItem('lotes2026') || '[]');
    let mesarios = JSON.parse(localStorage.getItem('mesarios2026') || JSON.stringify([
      {NOME: 'João Silva', INSCRICAO: '123456', FUNCAO_ELEITORAL: 'Presidente', LOCAL_DO_TRABALHO: 'Escola A', municipio: 'Concórdia', faltoso: true, folga: []},
      {NOME: 'Maria Oliveira', INSCRICAO: '789012', FUNCAO_ELEITORAL: 'Mesário', LOCAL_DO_TRABALHO: 'Escola B', municipio: 'Bujaru', faltoso: false, folga: [{data: '2026-10-01', motivo: 'Férias'}]},
      {NOME: 'Pedro Santos', INSCRICAO: '345678', FUNCAO_ELEITORAL: 'Secretário', LOCAL_DO_TRABALHO: 'Escola C', municipio: 'Concórdia', faltoso: false, folga: []},
    ]));
    let relatorioAtual = [];
    let graficoRelatorio;

    // Navegação
    function abrirSecao(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`[data-section="${id}"]`)?.classList.add('active');
      if (id === 'rel-mesarios') gerarRelatorio('todos');
      if (id === 'lotes-mov') atualizarTabelaLotes();
    }
    document.querySelectorAll('.nav-link').forEach(l => l.addEventListener('click', () => abrirSecao(l.dataset.section)));

    // Gráfico
    function atualizarGrafico(dados) {
      const faltosos = dados.filter(m => m.faltoso).length;
      const folga = dados.filter(m => m.folga && m.folga.length > 0).length;
      const ok = dados.length - faltosos - folga;
      const labels = ['Faltosos', 'Com Folga', 'OK'];
      const data = [faltosos, folga, ok];
      const colors = ['#ff6384', '#ffcd56', '#4bc0c0'];

      if (graficoRelatorio) graficoRelatorio.destroy();
      const ctx = document.getElementById('grafico-relatorio').getContext('2d');
      graficoRelatorio = new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets: [{ data, backgroundColor: colors }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    // Relatórios
    function gerarRelatorio(tipo) {
      let dados = [];
      let titulo = '';
      if (tipo === 'faltosos') { dados = mesarios.filter(m => m.faltoso); titulo = 'Mesários Faltosos'; }
      else if (tipo === 'folga') { dados = mesarios.filter(m => m.folga && m.folga.length > 0); titulo = 'Mesários com Folga'; }
      else { dados = mesarios; titulo = 'Todos os Mesários'; }
      relatorioAtual = dados;
      document.getElementById('titulo-relatorio').textContent = titulo;
      aplicarFiltroRelatorio();
      atualizarGrafico(dados);
    }
    function aplicarFiltroRelatorio() {
      let dados = relatorioAtual;
      const nome = document.getElementById('filtro-nome-rel').value.toLowerCase();
      const mun = document.getElementById('filtro-municipio-rel').value;
      if (nome) dados = dados.filter(m => m.NOME?.toLowerCase().includes(nome));
      if (mun) dados = dados.filter(m => m.municipio === mun);
      const tbody = document.querySelector('#tabela-relatorio tbody');
      tbody.innerHTML = dados.map(m => `
        <tr>
          <td>${m.NOME || ''}</td>
          <td>${m.INSCRICAO || ''}</td>
          <td>${m.FUNCAO_ELEITORAL || ''}</td>
          <td>${m.LOCAL_DO_TRABALHO || ''}</td>
          <td>${m.municipio || ''}</td>
          <td>${m.faltoso ? '<span class="badge bg-danger">Faltoso</span>' : (m.folga?.length > 0 ? '<span class="badge bg-warning">Folga</span>' : '<span class="badge bg-success">OK</span>')}</td>
        </tr>
      `).join('');
      document.getElementById('total-relatorio').textContent = `Exibindo: ${dados.length} mesário(s)`;
      atualizarGrafico(dados);
    }
    function exportarCSVRelatorio() {
      if (relatorioAtual.length === 0) return alert('Nenhum dado para exportar');
      const csv = "Nome,Inscrição,Função,Local,Município,Status\n" +
        relatorioAtual.map(m => `"${m.NOME || ''}","${m.INSCRICAO || ''}","${m.FUNCAO_ELEITORAL || ''}","${m.LOCAL_DO_TRABALHO || ''}","${m.municipio || ''}","${m.faltoso ? 'Faltoso' : (m.folga?.length > 0 ? 'Folga' : 'OK')}"`).join("\n");
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `relatorio-mesarios-${new Date().toISOString().slice(0,10)}.csv`; a.click();
    }
    function imprimirRelatorio() {
      window.print();
    }

    // Lotes
    function addLote() {
      const num = document.getElementById('lote-num').value.trim();
      const data = document.getElementById('lote-data').value;
      if (!num || !data) return alert('Preencha os campos');
      const dias = Math.floor((new Date() - new Date(data)) / 86400000);
      lotes.push({num, data, dias, status: dias < 10 ? 'NO PRAZO' : 'PRAZO VENCIDO', arquivado: false});
      localStorage.setItem('lotes2026', JSON.stringify(lotes));
      atualizarTabelaLotes();
      document.getElementById('lote-num').value = '';
      document.getElementById('lote-data').value = '';
    }
    function atualizarTabelaLotes() {
      const tbody = document.querySelector('#tabela-lotes tbody');
      tbody.innerHTML = lotes.filter(l => !l.arquivado).map(l => `
        <tr>
          <td>${l.num}</td>
          <td>${l.data}</td>
          <td>${l.dias}</td>
          <td><span class="badge ${l.status === 'NO PRAZO' ? 'bg-success' : 'bg-danger'}">${l.status}</span></td>
          <td><button class="btn btn-sm btn-outline-danger no-print" onclick="lotes = lotes.filter(x=>x.num!=='${l.num}'); localStorage.setItem('lotes2026', JSON.stringify(lotes)); atualizarTabelaLotes();">Excluir</button></td>
        </tr>
      `).join('');
    }

    // Tema escuro
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('dark2026', document.body.classList.contains('dark-mode'));
    }
    if (localStorage.getItem('dark2026') === 'true') document.body.classList.add('dark-mode');

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
      atualizarTabelaLotes();
      gerarRelatorio('todos');
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
